!function(t){"use strict";function e(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=e.concat(n);return t.apply(null,o)}}function n(e,n){return i(t.document.createElement("canvas"),e,n)}function r(t){var e=n(t.width,t.height);return o(e).drawImage(t,0,0),e}function o(t){return t.getContext("2d")}function i(t,e,n){return t.width=e,t.height=n,t}function a(t){return t.naturalWidth||t.width}function c(t){return t.naturalHeight||t.height}function u(e){var n,r=e.src;return 0===r.indexOf("data:")?f(r):(n=r,new G(function(e,r){var o=new t.XMLHttpRequest;o.open("GET",n,!0),o.responseType="blob",o.onload=function(){200===this.status&&e(this.response)},o.onerror=function(){var t,e=this;r(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},o.send()}))}function l(e){return new G(function(n,r){function o(){u(),n(c)}function i(){u(),r("Unable to load data of type "+e.type+": "+a)}var a=t.URL.createObjectURL(e),c=new t.Image,u=function(){c.removeEventListener("load",o),c.removeEventListener("error",i)};c.addEventListener("load",o),c.addEventListener("error",i),c.src=a,c.complete&&o()})}function f(e){return new G(function(n,r){(function(e){var n=e.split(","),r=/data:([^;]+)/.exec(n[0]);if(!r)return Y.none();for(var o=r[1],i=n[1],a=t.atob(i),c=a.length,u=Math.ceil(c/1024),l=new Array(u),f=0;f<u;++f){for(var s=1024*f,d=Math.min(s+1024,c),h=new Array(d-s),p=s,m=0;p<d;++m,++p)h[m]=a[p].charCodeAt(0);l[f]=new Uint8Array(h)}return Y.some(new t.Blob(l,{type:o}))})(e).fold(function(){r("uri is not base64: "+e)},n)})}function s(e,n,r){return n=n||"image/png",t.HTMLCanvasElement.prototype.toBlob?new G(function(t,o){e.toBlob(function(e){e?t(e):o()},n,r)}):f(e.toDataURL(n,r))}function d(e){return l(e).then(function(e){var r;r=e,t.URL.revokeObjectURL(r.src);var i=n(a(e),c(e));return o(i).drawImage(e,0,0),i})}function h(t,e,n){function o(e,n){return t.then(function(t){return o=n,r=(r=e)||"image/png",t.toDataURL(r,o);var r,o})}var i=e.type;return{getType:V(i),toBlob:function(){return G.resolve(e)},toDataURL:function(){return n},toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return s(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(r)}}}function p(e){return(n=e,new G(function(e){var r=new t.FileReader;r.onloadend=function(){e(r.result)},r.readAsDataURL(n)})).then(function(t){return h(d(e),e,t)});var n}function m(t,e){return s(t,e).then(function(e){return h(G.resolve(t),e,t.toDataURL())})}function g(t,e,n){var r="string"==typeof t?parseFloat(t):t;return n<r?r=n:r<e&&(r=e),r}function v(t,e){for(var n,r=[],o=new Array(25),i=0;i<5;i++){for(var a=0;a<5;a++)r[a]=e[a+5*i];for(a=0;a<5;a++){for(var c=n=0;c<5;c++)n+=t[a+5*c]*r[c];o[a+5*i]=n}}return o}function y(t,e){return e=g(e,0,1),t.map(function(t,n){return n%6==0?t=1-(1-t)*e:t*=e,g(t,0,1)})}function w(t,e){return t.toCanvas().then(function(n){return r=n,i=t.getType(),a=e,u=function(t,e){for(var n,r,o,i,a=t.data,c=e[0],u=e[1],l=e[2],f=e[3],s=e[4],d=e[5],h=e[6],p=e[7],m=e[8],g=e[9],v=e[10],y=e[11],w=e[12],b=e[13],x=e[14],k=e[15],R=e[16],I=e[17],M=e[18],T=e[19],U=0;U<a.length;U+=4)n=a[U],r=a[U+1],o=a[U+2],i=a[U+3],a[U]=n*c+r*u+o*l+i*f+s,a[U+1]=n*d+r*h+o*p+i*m+g,a[U+2]=n*v+r*y+o*w+i*b+x,a[U+3]=n*k+r*R+o*I+i*M+T;return t}((c=o(r)).getImageData(0,0,r.width,r.height),a),c.putImageData(u,0,0),m(r,i);var r,i,a,c,u})}function b(t,e){return t.toCanvas().then(function(n){return r=n,i=t.getType(),a=e,u=function(t,e,n){function r(t,e,n){return n<t?t=n:t<e&&(t=e),t}for(var o=Math.round(Math.sqrt(n.length)),i=Math.floor(o/2),a=t.data,c=e.data,u=t.width,l=t.height,f=0;f<l;f++)for(var s=0;s<u;s++){for(var d=0,h=0,p=0,m=0;m<o;m++)for(var g=0;g<o;g++){var v=r(s+g-i,0,u-1),y=4*(r(f+m-i,0,l-1)*u+v),w=n[m*o+g];d+=a[y]*w,h+=a[y+1]*w,p+=a[y+2]*w}var b=4*(f*u+s);c[b]=r(d,0,255),c[b+1]=r(h,0,255),c[b+2]=r(p,0,255)}return e}((c=o(r)).getImageData(0,0,r.width,r.height),u=c.getImageData(0,0,r.width,r.height),a),c.putImageData(u,0,0),m(r,i);var r,i,a,c,u})}function x(t){return function(e,n){return e.toCanvas().then(function(r){return function(e,n,r){for(var i=o(e),a=new Array(256),c=0;c<a.length;c++)a[c]=t(c,r);var u=function(t,e){for(var n=t.data,r=0;r<n.length;r+=4)n[r]=e[n[r]],n[r+1]=e[n[r+1]],n[r+2]=e[n[r+2]];return t}(i.getImageData(0,0,e.width,e.height),a);return i.putImageData(u,0,0),m(e,n)}(r,e.getType(),n)})}}function k(t){return function(e,n){return w(e,t([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],n))}}function R(t){return function(e){return b(e,t)}}function I(t,e,r){var i=a(t),u=c(t),l=e/i,f=r/u,s=!1;(l<.5||2<l)&&(l=l<.5?.5:2,s=!0),(f<.5||2<f)&&(f=f<.5?.5:2,s=!0);var d,h,p,m=(d=t,h=l,p=f,new G(function(t){var e=a(d),r=c(d),i=Math.floor(e*h),u=Math.floor(r*p),l=n(i,u);o(l).drawImage(d,0,0,e,r,0,0,i,u),t(l)}));return s?m.then(function(t){return I(t,e,r)}):m}function M(t,e){return t.toCanvas().then(function(r){return a=r,c=t.getType(),u=e,f=o(l=n(a.width,a.height)),90!==(u=u<(d=s=0)?360+u:u)&&270!==u||i(l,l.height,l.width),90!==u&&180!==u||(s=l.width),270!==u&&180!==u||(d=l.height),f.translate(s,d),f.rotate(u*Math.PI/180),f.drawImage(a,0,0),m(l,c);var a,c,u,l,f,s,d})}function T(t,e){return t.toCanvas().then(function(r){return i=r,a=t.getType(),c=e,l=o(u=n(i.width,i.height)),"v"===c?(l.scale(1,-1),l.drawImage(i,0,-u.height)):(l.scale(-1,1),l.drawImage(i,-u.width,0)),m(u,a);var i,a,c,u,l})}function U(t,e,r,i,a){return t.toCanvas().then(function(c){return u=c,l=t.getType(),f=e,s=r,o(d=n(i,a)).drawImage(u,-f,-s),m(d,l);var u,l,f,s,d})}function C(t){return{blob:t,url:Et.createObjectURL(t)}}function A(t){t&&Et.revokeObjectURL(t.url)}function E(t){D.each(t,A)}function O(t,e,n,r){function o(t){var e,n,r,o;e=y.find("#w")[0],n=y.find("#h")[0],r=parseInt(e.value(),10),o=parseInt(n.value(),10),y.find("#constrain")[0].checked()&&q&&$&&r&&o&&("w"===t.control.settings.name?(o=Math.round(r*X),n.value(o)):(r=Math.round(o*Y),e.value(r))),q=r,$=o}function i(t){return Math.round(100*t)+"%"}function a(){y.find("#undo").disabled(!G.canUndo()),y.find("#redo").disabled(!G.canRedo()),y.statusbar.find("#save").disabled(!G.canUndo())}function c(){y.find("#undo").disabled(!0),y.find("#redo").disabled(!0)}function u(t){t&&M.imageSrc(t.url)}function l(t){return function(){var e=D.grep(N,function(e){return e.settings.name!==t});D.each(e,function(t){t.hide()}),t.show(),t.focus()}}function f(t){u(x=C(t))}function s(t){u(e=C(t)),E(G.add(e).removed),a()}function d(){var t=M.selection();Mt(e.blob).then(function(e){kt(e,t.x,t.y,t.w,t.h).then(Z).then(function(t){s(t),h()})})}function h(){u(e),A(x),l(w)(),a()}function p(){x?(s(x.blob),h()):function e(n,r){x?r():setTimeout(function(){0<n--?e(n,r):t.windowManager.alert("Error: failed to apply image operation.")},10)}(100,p)}function m(t){return Lt.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}function g(t,n){return m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){c(),Mt(e.blob).then(function(t){return n(t)}).then(Z).then(function(t){var e=C(t);u(e),A(x),x=e})})}function v(n,r,o,a,l){return m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){var n;n=t.value,Mt(e.blob).then(function(t){return r(t,n)}).then(Z).then(function(t){var e=C(t);u(e),A(x),x=e})},minValue:t.rtl?l:a,maxValue:t.rtl?a:l,value:o,previewFilter:i},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){this.find("slider").value(o),c()})}var y,w,b,x,k,R,I,M,T,U,O,_,j,z,L,B,S,P,H,F,V,W,N,q,$,X,Y,G=function(){function t(){return 0<r}function e(){return-1!==r&&r<n.length-1}var n=[],r=-1;return{data:n,add:function(t){var e;return e=n.splice(++r),n.push(t),{state:t,removed:e}},undo:function(){if(t())return n[--r]},redo:function(){if(e())return n[++r]},canUndo:t,canRedo:e}}(),K=function(e){return t.rtl?e.reverse():e},J=function(t){var n=[].slice.call(arguments,1);return function(){Mt((x||e).blob).then(function(e){t.apply(this,[e].concat(n)).then(Z).then(f)})}},Z=function(t){return t.toBlob()};k=m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:d}])).hide().on("show hide",function(t){M.toggleCropRect("show"===t.type)}).on("show",c),R=m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:o},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:o},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(X=$/q,Y=q/$)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(t){var n=parseInt(y.find("#w").value(),10),r=parseInt(y.find("#h").value(),10);t.preventDefault(),function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=[].slice.call(arguments,1);return function(){Mt(e.blob).then(function(e){t.apply(this,[e].concat(o)).then(Z).then(s)})}}(Rt,n,r)(),h()}).on("show",c),I=m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:J(xt,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:J(xt,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:J(It,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:J(It,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",c),O=g(0,lt),H=g(0,ft),F=g(0,st),_=v(0,mt,0,-1,1),j=v(0,gt,180,0,360),z=v(0,vt,0,-1,1),L=v(0,yt,0,-1,1),B=v(0,wt,0,0,1),S=v(0,bt,0,0,1),P=function(n,r){function o(){var t,n,o;t=y.find("#r")[0].value(),n=y.find("#g")[0].value(),o=y.find("#b")[0].value(),Mt(e.blob).then(function(e){return r(e,t,n,o)}).then(Z).then(function(t){var e=C(t);u(e),A(x),x=e})}var a=t.rtl?2:0,l=t.rtl?0:2;return m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"slider",label:"G",name:"g",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"slider",label:"B",name:"b",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show",function(){y.find("#r,#g,#b").value(1),c()})}(0,pt),V=v(0,dt,0,-1,1),W=v(0,ht,1,0,2),b=m(K([{text:"Back",onclick:h},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:l(j)},{text:"saturate",icon:"saturate",onclick:l(z)},{text:"sepia",icon:"sepia",onclick:l(S)},{text:"emboss",icon:"emboss",onclick:l(F)},{text:"exposure",icon:"exposure",onclick:l(W)},{type:"spacer",flex:1}])).hide(),w=m(K([{tooltip:"Crop",icon:"crop",onclick:l(k)},{tooltip:"Resize",icon:"resize2",onclick:l(R)},{tooltip:"Orientation",icon:"orientation",onclick:l(I)},{tooltip:"Brightness",icon:"sun",onclick:l(_)},{tooltip:"Sharpen",icon:"sharpen",onclick:l(H)},{tooltip:"Contrast",icon:"contrast",onclick:l(L)},{tooltip:"Color levels",icon:"drop",onclick:l(P)},{tooltip:"Gamma",icon:"gamma",onclick:l(V)},{tooltip:"Invert",icon:"invert",onclick:l(O)}])),M=Vt.create({flex:1,imageSrc:e.url}),T=Lt.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){u(e=G.undo()),a()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){u(e=G.redo()),a()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=M.zoom();t<2&&(t+=.1),M.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=M.zoom();.1<t&&(t-=.1),M.zoom(t)}}]}),U=Lt.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:K([T,M])}),N=[w,k,R,I,b,O,_,j,z,L,B,S,P,H,F,V,W],(y=t.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(zt.DOM.getViewPort().w,800),minHeight:Math.min(zt.DOM.getViewPort().h,650),title:"Edit image",items:N.concat([U]),buttons:K([{text:"Save",name:"save",subtype:"primary",onclick:function(){n(e.blob),y.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){r(),E(G.data),x=G=null}),G.add(e),a(),M.on("load",function(){q=M.imageSize().w,$=M.imageSize().h,X=$/q,Y=q/$,y.find("#w").value(q),y.find("#h").value($)}),M.on("crop",d)}var _,j,z,L,B,S,P=function(t){var e=t,n=function(){return e};return{get:n,set:function(t){e=t},clone:function(){return P(n())}}},H=tinymce.util.Tools.resolve("tinymce.PluginManager"),D=tinymce.util.Tools.resolve("tinymce.util.Tools"),F=function(){},V=function(t){return function(){return t}},W=V(!1),N=V(!0),q=function(){return $},$=(_=function(t){return t.isNone()},L={fold:function(t){return t()},is:W,isSome:W,isNone:N,getOr:z=function(t){return t},getOrThunk:j=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:V(null),getOrUndefined:V(undefined),or:z,orThunk:j,map:q,each:F,bind:q,exists:W,forall:N,filter:q,equals:_,equals_:_,toArray:function(){return[]},toString:V("none()")},Object.freeze&&Object.freeze(L),L),X=function(t){var e=V(t),n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:N,isNone:W,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return X(e(t))},each:function(e){e(t)},bind:r,exists:r,forall:r,filter:function(e){return e(t)?o:$},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(W,function(e){return n(t,e)})}};return o},Y={some:X,none:q,from:function(t){return null===t||t===undefined?$:X(t)}},G=window.Promise?window.Promise:function(){function e(t,e){return function(){return t.apply(e,arguments)}}function n(t){var e=this;null!==this._state?l(function(){var n=e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(f){return void t.reject(f)}t.resolve(r)}else(e._state?t.resolve:t.reject)(e._value)}):this._deferreds.push(t)}function r(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void c(e(n,t),e(r,this),e(o,this))}this._state=!0,this._value=t,i.call(this)}catch(f){o.call(this,f)}}function o(t){this._state=!1,this._value=t,i.call(this)}function i(){for(var t=0,e=this._deferreds;t<e.length;t++){var r=e[t];n.call(this,r)}this._deferreds=[]}function a(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function c(t,e,n){var o=!1;try{t(function(t){o||(o=!0,e(t))},function(t){o||(o=!0,n(t))})}catch(r){if(o)return;o=!0,n(r)}}var u=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],c(t,e(r,this),e(o,this))},l=u.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(e){t.setTimeout(e,1)},f=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};return u.prototype["catch"]=function(t){return this.then(null,t)},u.prototype.then=function(t,e){var r=this;return new u(function(o,i){n.call(r,new a(t,e,o,i))})},u.all=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=Array.prototype.slice.call(1===t.length&&f(t[0])?t[0]:t);return new u(function(t,n){function o(a,c){try{if(c&&("object"==typeof c||"function"==typeof c)){var u=c.then;if("function"==typeof u)return void u.call(c,function(t){o(a,t)},n)}r[a]=c,0==--i&&t(r)}catch(e){n(e)}}if(0===r.length)return t([]);for(var i=r.length,a=0;a<r.length;a++)o(a,r[a])})},u.resolve=function(t){return t&&"object"==typeof t&&t.constructor===u?t:new u(function(e){e(t)})},u.reject=function(t){return new u(function(e,n){n(t)})},u.race=function(t){return new u(function(e,n){for(var r=0,o=t;r<o.length;r++)o[r].then(e,n)})},u}(),K=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],J=(B=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0,0,0,0,0,1],function(t){return w(t,B)}),Z=k(function(t,e){return v(t,[1,0,0,0,e=g(255*e,-255,255),0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}),Q=k(function(t,e){e=g(e,-180,180)/180*Math.PI;var n=Math.cos(e),r=Math.sin(e),o=.213,i=.715,a=.072;return v(t,[o+.787*n+r*-o,i+n*-i+r*-i,a+n*-a+.928*r,0,0,o+n*-o+.143*r,i+n*(1-i)+.14*r,a+n*-a+-.283*r,0,0,o+n*-o+-.787*r,i+n*-i+r*i,a+.928*n+r*a,0,0,0,0,0,1,0,0,0,0,0,1])}),tt=k(function(t,e){var n=1+(0<(e=g(e,-1,1))?3*e:e);return v(t,[.3086*(1-n)+n,.6094*(1-n),.082*(1-n),0,0,.3086*(1-n),.6094*(1-n)+n,.082*(1-n),0,0,.3086*(1-n),.6094*(1-n),.082*(1-n)+n,0,0,0,0,0,1,0,0,0,0,0,1])}),et=k(function(t,e){var n;return e=g(e,-1,1),v(t,[(n=(e*=100)<0?127+e/100*127:127*(n=0==(n=e%1)?K[e]:K[Math.floor(e)]*(1-n)+K[Math.floor(e)+1]*n)+127)/127,0,0,0,.5*(127-n),0,n/127,0,0,.5*(127-n),0,0,n/127,0,.5*(127-n),0,0,0,1,0,0,0,0,0,1])}),nt=k(function(t,e){return v(t,y([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],e=g(e,0,1)))}),rt=k(function(t,e){return v(t,y([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],e=g(e,0,1)))}),ot=function(t,e,n,r){return w(t,(o=n,i=r,v([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],[g(e,0,2),0,0,0,0,0,o=g(o,0,2),0,0,0,0,0,i=g(i,0,2),0,0,0,0,0,1,0,0,0,0,0,1])));var o,i},it=R([0,-1,0,-1,5,-1,0,-1,0]),at=R([-2,-1,0,-1,1,1,0,1,2]),ct=x(function(t,e){return 255*Math.pow(t/255,1-e)}),ut=x(function(t,e){return 255*(1-Math.exp(-t/255*e))}),lt=function(t){return J(t)},ft=function(t){return it(t)},st=function(t){return at(t)},dt=function(t,e){return ct(t,e)},ht=function(t,e){return ut(t,e)},pt=function(t,e,n,r){return ot(t,e,n,r)},mt=function(t,e){return Z(t,e)},gt=function(t,e){return Q(t,e)},vt=function(t,e){return tt(t,e)},yt=function(t,e){return et(t,e)},wt=function(t,e){return nt(t,e)},bt=function(t,e){return rt(t,e)},xt=function(t,e){return T(t,e)},kt=function(t,e,n,r,o){return U(t,e,n,r,o)},Rt=function(t,e,n){return o=e,i=n,(r=t).toCanvas().then(function(t){return I(t,o,i).then(function(t){return m(t,r.getType())})});var r,o,i},It=function(t,e){return M(t,e)},Mt=function(t){return p(t)},Tt="undefined"!=typeof t.window?t.window:Function("return this;")(),Ut=function(t,e){return function(t,e){for(var n=e!==undefined&&null!==e?e:Tt,r=0;r<t.length&&n!==undefined&&null!==n;++r)n=n[t[r]];return n}(t.split("."),e)},Ct=function(t,e){var n=Ut(t,e);if(n===undefined||null===n)throw new Error(t+" not available on this browser");return n},At=function(){return Ct("URL")},Et={createObjectURL:function(t){return At().createObjectURL(t)},revokeObjectURL:function(t){At().revokeObjectURL(t)}},Ot=tinymce.util.Tools.resolve("tinymce.util.Delay"),_t=tinymce.util.Tools.resolve("tinymce.util.Promise"),jt=tinymce.util.Tools.resolve("tinymce.util.URI"),zt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),Lt=tinymce.util.Tools.resolve("tinymce.ui.Factory"),Bt=tinymce.util.Tools.resolve("tinymce.geom.Rect"),St=function(t){return new _t(function(e){var n=function(){t.removeEventListener("load",n),e(t)};t.complete?e(t):t.addEventListener("load",n)})},Pt=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),Ht=tinymce.util.Tools.resolve("tinymce.util.Observable"),Dt=tinymce.util.Tools.resolve("tinymce.util.VK"),Ft=0,Vt={create:function(e){return new(Lt.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(e){var n=this,r=new t.Image;r.src=e,St(r).then(function(){var e,o,i=n.state.get("viewRect");if((o=n.$el.find("img"))[0])o.replaceWith(r);else{var a=t.document.createElement("div");a.className="mce-imagepanel-bg",n.getEl().appendChild(a),n.getEl().appendChild(r)}e={x:0,y:0,w:r.naturalWidth,h:r.naturalHeight},n.state.set("viewRect",e),n.state.set("rect",Bt.inflate(e,-20,-20)),i&&i.w===e.w&&i.h===e.h||n.zoomFit(),n.repaintImage(),n.fire("load")})},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t,e,n,r,o,i;t=this.$el.find("img"),e=this.getEl().clientWidth,n=this.getEl().clientHeight,r=t[0].naturalWidth,o=t[0].naturalHeight,1<=(i=Math.min((e-10)/r,(n-10)/o))&&(i=1),this.zoom(i)},repaintImage:function(){var t,e,n,r,o,i,a,c,u,l,f;f=this.getEl(),u=this.zoom(),l=this.state.get("rect"),a=this.$el.find("img"),c=this.$el.find(".mce-imagepanel-bg"),o=f.offsetWidth,i=f.offsetHeight,n=a[0].naturalWidth*u,r=a[0].naturalHeight*u,t=Math.max(0,o/2-n/2),e=Math.max(0,i/2-r/2),a.css({left:t,top:e,width:n,height:r}),c.css({left:t,top:e,width:n,height:r}),this.cropRect&&(this.cropRect.setRect({x:l.x*u+t,y:l.y*u+e,w:l.w*u,h:l.h*u}),this.cropRect.setClampRect({x:t,y:e,w:n,h:r}),this.cropRect.setViewPortRect({x:0,y:0,w:o,h:i}))},bindStates:function(){function t(t){e.cropRect=function(t,e,n,r,o){function i(t,e){return{x:e.x-t.x,y:e.y-t.y,w:e.w,h:e.h}}function a(e,r,o,a){var c,u,s,d,h;c=r.x,u=r.y,s=r.w,d=r.h,c+=o*e.deltaX,u+=a*e.deltaY,(s+=o*e.deltaW)<20&&(s=20),(d+=a*e.deltaH)<20&&(d=20),h=t=Bt.clamp({x:c,y:u,w:s,h:d},n,"move"===e.name),h=i(n,h),f.fire("updateRect",{rect:h}),l(h)}function c(t){function n(t,e){e.h<0&&(e.h=0),e.w<0&&(e.w=0),Pt("#"+m+"-"+t,r).css({left:e.x,top:e.y,width:e.w,height:e.h})}D.each(s,function(e){Pt("#"+m+"-"+e.name,r).css({left:t.w*e.xMul+t.x,top:t.h*e.yMul+t.y})}),n("top",{x:e.x,y:e.y,w:e.w,h:t.y-e.y}),n("right",{x:t.x+t.w,y:t.y,w:e.w-t.x-t.w+e.x,h:t.h}),n("bottom",{x:e.x,y:t.y+t.h,w:e.w,h:e.h-t.y-t.h+e.y}),n("left",{x:e.x,y:t.y,w:t.x-e.x,h:t.h}),n("move",t)}function u(e){c(t=e)}function l(t){var e,r;u((e=n,{x:(r=t).x+e.x,y:r.y+e.y,w:r.w,h:r.h}))}var f,s,d,h,p="mce-",m=p+"crid-"+Ft++;return s=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],h=["top","right","bottom","left"],Pt('<div id="'+m+'" class="'+p+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(r),D.each(h,function(t){Pt("#"+m,r).append('<div id="'+m+"-"+t+'"class="'+p+'croprect-block" style="display: none" data-mce-bogus="all">')}),D.each(s,function(t){Pt("#"+m,r).append('<div id="'+m+"-"+t.name+'" class="'+p+"croprect-handle "+p+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),d=D.map(s,function(e){var n;return new(Lt.get("DragHelper"))(m,{document:r.ownerDocument,handle:m+"-"+e.name,start:function(){n=t},drag:function(t){a(e,n,t.deltaX,t.deltaY)}})}),c(t),Pt(r).on("focusin focusout",function(t){Pt(t.target).attr("aria-grabbed","focus"===t.type)}),Pt(r).on("keydown",function(e){function n(t,e,n,o,i){t.stopPropagation(),t.preventDefault(),a(r,n,o,i)}var r;switch(D.each(s,function(t){if(e.target.id===m+"-"+t.name)return r=t,!1}),e.keyCode){case Dt.LEFT:n(e,0,t,-10,0);break;case Dt.RIGHT:n(e,0,t,10,0);break;case Dt.UP:n(e,0,t,0,-10);break;case Dt.DOWN:n(e,0,t,0,10);break;case Dt.ENTER:case Dt.SPACEBAR:e.preventDefault(),o()}}),f=D.extend({toggleVisibility:function(t){var e;e=D.map(s,function(t){return"#"+m+"-"+t.name}).concat(D.map(h,function(t){return"#"+m+"-"+t})).join(","),t?Pt(e,r).show():Pt(e,r).hide()},setClampRect:function(e){n=e,c(t)},setRect:u,getInnerRect:function(){return i(n,t)},setInnerRect:l,setViewPortRect:function(n){e=n,c(t)},destroy:function(){D.each(d,function(t){t.destroy()}),d=[]}},Ht)}(t,e.state.get("viewRect"),e.state.get("viewRect"),e.getEl(),function(){e.fire("crop")}),e.cropRect.on("updateRect",function(t){var n=t.rect,r=e.zoom();n={x:Math.round(n.x/r),y:Math.round(n.y/r),w:Math.round(n.w/r),h:Math.round(n.h/r)},e.state.set("rect",n)}),e.on("remove",e.cropRect.destroy)}var e=this;e.state.on("change:cropEnabled",function(t){e.cropRect.toggleVisibility(t.value),e.repaintImage()}),e.state.on("change:zoom",function(){e.repaintImage()}),e.state.on("change:rect",function(n){var r=n.value;e.cropRect||t(r),e.cropRect.setRect(r)})}}))(e)}},Wt={edit:function(t,e){return new _t(function(n,r){return e.toBlob().then(function(e){O(t,C(e),n,r)})})}},Nt={getImageSize:function(t){function e(t){return/^[0-9\.]+px$/.test(t)}var n,r;return n=t.style.width,r=t.style.height,n||r?e(n)&&e(r)?{w:parseInt(n,10),h:parseInt(r,10)}:null:(n=t.width,r=t.height,n&&r?{w:parseInt(n,10),h:parseInt(r,10)}:null)},setImageSize:function(t,e){var n,r;e&&(n=t.style.width,r=t.style.height,(n||r)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,r=t.height,(n||r)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))},getNaturalImageSize:function(t){return{w:t.naturalWidth,h:t.naturalHeight}}},qt=(S="function",function(t){return function(t){if(null===t)return"null";var e=typeof t;return"object"===e&&(Array.prototype.isPrototypeOf(t)||t.constructor&&"Array"===t.constructor.name)?"array":"object"===e&&(String.prototype.isPrototypeOf(t)||t.constructor&&"String"===t.constructor.name)?"string":e}(t)===S}),$t=(Array.prototype.slice,function(t,e){for(var n=0,r=t.length;n<r;n++){var o=t[n];if(e(o,n))return Y.some(o)}return Y.none()});qt(Array.from)&&Array.from;var Xt=function(t){return null!==t&&t!==undefined},Yt=function(t,e){var n;return n=e.reduce(function(t,e){return Xt(t)?t[e]:undefined},t),Xt(n)?n:null},Gt=function(t){return new _t(function(e){var n=new(Ct("FileReader"));n.onload=function(t){var n=t.target;e(n.result)},n.readAsText(t)})},Kt=function(t,e,n){return new _t(function(r){var o;(o=new(Ct("XMLHttpRequest"))).onreadystatechange=function(){4===o.readyState&&r({status:o.status,blob:this.response})},o.open("GET",t,!0),o.withCredentials=n,D.each(e,function(t,e){o.setRequestHeader(e,t)}),o.responseType="blob",o.send()})},Jt=function(t){var e;try{e=JSON.parse(t)}catch(_){}return e},Zt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Qt=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],te=function(t){return"ImageProxy HTTP error: "+$t(Zt,function(e){return t===e.code}).fold(V("Unknown ImageProxy error"),function(t){return t.message})},ee=function(t){var e=te(t);return _t.reject(e)},ne=function(t){return $t(Qt,function(e){return e.type===t}).fold(V("Unknown service error"),function(t){return t.message})},re=function(t,e){return Gt(e).then(function(t){var e,n,r=(e=Jt(t),"ImageProxy Service error: "+((n=Yt(e,["error","type"]))?ne(n):"Invalid JSON in service error message"));return _t.reject(r)})},oe=function(t,e){return 400===(n=t)||403===n||500===n?re(0,e):ee(t);var n},ie=ee,ae=function(t,e){var n,r,o,i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return Kt((n=t,r=e,o=-1===n.indexOf("?")?"?":"&",/[?&]apiKey=/.test(n)||!r?n:n+o+"apiKey="+encodeURIComponent(r)),i,!1).then(function(t){return t.status<200||300<=t.status?oe(t.status,t.blob):_t.resolve(t.blob)})},ce=function(t,e,n){return e?ae(t,e):Kt(t,{},n).then(function(t){return t.status<200||300<=t.status?ie(t.status):_t.resolve(t.blob)})},ue=0,le=function(t,e){t.notificationManager.open({text:e,type:"error"})},fe=function(t){return t.selection.getNode()},se=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new jt(n).host===t.documentBaseURI.host},de=function(t,e){return-1!==D.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new jt(e.src).host)},he=function(t,e){var n,r,o,i,a=e.src;return de(t,e)?ce(e.src,null,(r=t,o=e,-1!==D.inArray(r.getParam("imagetools_credentials_hosts",[],"string[]"),new jt(o.src).host))):se(t,e)?u(e):(a=t.getParam("imagetools_proxy"),a+=(-1===a.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),n=(i=t).getParam("api_key",i.getParam("imagetools_api_key","","string"),"string"),ce(a,n,!1))},pe=function(t){var e;return(e=t.editorUpload.blobCache.getByUri(fe(t).src))?_t.resolve(e.blob()):he(t,fe(t))},me=function(t){clearTimeout(t.get())},ge=function(t,e,n,r,o){return e.toBlob().then(function(i){var a,c,u,l,f,s,d;return u=t.editorUpload.blobCache,a=(f=fe(t)).src,t.getParam("images_reuse_filename",!1,"boolean")&&((l=u.getByUri(a))?(a=l.uri(),c=l.name()):(s=t,c=(d=a.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?s.dom.encode(d[1]):null)),l=u.create({id:"imagetools"+ue++,blob:i,base64:e.toBase64(),uri:a,name:c}),u.add(l),t.undoManager.transact(function(){t.$(f).on("load",function e(){var o,i,a;t.$(f).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(me(r),o=t,i=r,a=Ot.setEditorTimeout(o,function(){o.editorUpload.uploadImagesAuto()},o.getParam("images_upload_timeout",3e4,"number")),i.set(a))}),o&&t.$(f).attr({width:o.w,height:o.h}),t.$(f).attr({src:l.blobUri()}).removeAttr("data-mce-src")}),l})},ve=function(t,n,r,o){return function(){return t._scanForImages().then(e(pe,t)).then(Mt).then(r).then(function(e){return ge(t,e,!1,n,o)},function(e){le(t,e)})}},ye=function(t,e,n){return function(){var r=Nt.getImageSize(fe(t)),o=r?{w:r.h,h:r.w}:null;return ve(t,e,function(t){return It(t,n)},o)()}},we=function(t,e,n){return function(){return ve(t,e,function(t){return xt(t,n)})()}},be=function(t,n){return function(){var r=fe(t),o=Nt.getNaturalImageSize(r),i=function(t){return new _t(function(e){var n;(n=t,l(n)).then(function(n){var i=Nt.getNaturalImageSize(n);o.w===i.w&&o.h===i.h||Nt.getImageSize(r)&&Nt.setImageSize(r,i),Et.revokeObjectURL(n.src),e(t)})})};pe(t).then(Mt).then(e(function(t,e){return Wt.edit(t,e).then(i).then(Mt).then(function(e){return ge(t,e,!0,n)},function(){})},t),function(e){le(t,e)})}},xe=function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(se(t,e)||de(t,e)||t.settings.imagetools_proxy)},ke=me,Re=function(t,e){D.each({mceImageRotateLeft:ye(t,e,-90),mceImageRotateRight:ye(t,e,90),mceImageFlipVertical:we(t,e,"v"),mceImageFlipHorizontal:we(t,e,"h"),mceEditImage:be(t,e)},function(e,n){t.addCommand(n,e)})},Ie=function(t,e,n){t.on("NodeChange",function(r){var o=n.get();o&&o.src!==r.element.src&&(ke(e),t.editorUpload.uploadImagesAuto(),n.set(null)),xe(t,r.element)&&n.set(r.element)})},Me=function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})},Te=function(t){t.addContextToolbar(e(xe,t),t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions"))};H.add("imagetools",function(t){var e=P(0),n=P(null);Re(t,e),Me(t),Te(t),Ie(t,e,n)})}(window);